name: Generate folder for add-on authors

on:
  workflow_dispatch:
jobs:
  generateSharedFolder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repo
      uses: actions/checkout@v5
    - name: "Set up Python"
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v6
    - name: Transform
      run: |
        cd addons
        for dir in *; do
        [ -d "$dir" ] || continue
        addon=$(basename "$dir")
        cd "$addon"
        for lang in *; do
        [ -f "$lang/$addon.po" ] || continue
        mkdir -p "../shared/$addon/locale/$lang/LC_MESSAGES"
        mv -f "$lang/$addon.po" "../shared/$addon/locale/$lang/LC_MESSAGES/nvda.po"
        [ -f "$lang/$addon.xliff" ] || continue
          uv run ./utils/l10nUtil.py xliff2md "$lang/$addon.xliff" "../shared/$addon/doc/$lang/readme.md"
          cd ..
        done
        done
        ls -R
    - name: Commit and push shared folder
      id: commit
      run: |
        git config --local user.name github-actions
        git config --local user.email github-actions@github.com
        git add shared
        if git diff --staged --quiet; then
        echo "Nothing added to commit."
        echo "has_changes=false" >> $GITHUB_OUTPUT
        else
        echo "has_changes=true" >> $GITHUB_OUTPUT
        git commit -m "Update shared folder"
        git push
        fi
